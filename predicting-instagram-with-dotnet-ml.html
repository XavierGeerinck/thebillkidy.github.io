<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Predicting Instagram Pictures Likes and Comments with .NET Core and ML.NET</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs2015.min.css">
    <style>.hljs { background: none; }</style>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="My thoughts, tutorials and learnings" />
    <link rel="shortcut icon" href="/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="/predicting-instagram-with-dotnet-ml" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Xavier Geerinck - Blog" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Predicting Instagram Pictures Likes and Comments with .NET Core and ML.NET" />
    <meta property="og:description" content="For a new fun Project, I wanted to create an Artificial Intelligence model that will allow me to predict the comments and likes of new pictures that a user can post on Instagram based on their own historical data. Luckily thanks to ML.NET which was released during build 2018, we" />
    <meta property="og:url" content="/predicting-instagram-with-dotnet-ml" />
    <meta property="og:image" content="/assets/images/covers/gif/brain.gif" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2018-08-24T09:00:00+00:00" />
    <meta property="article:modified_time" content="2018-08-24T09:00:00+00:00" />
    <meta property="article:tag" content="Coding" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Predicting Instagram Pictures Likes and Comments with .NET Core and ML.NET" />
    <meta name="twitter:description" content="For a new fun Project, I wanted to create an Artificial Intelligence model that will allow me to predict the comments and likes of new pictures that a user can post on Instagram based on their own historical data. Luckily thanks to ML.NET which was released during build 2018, we" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image" content="/assets/images/covers/gif/brain.gif" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Xavier Geerinck - Blog" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Coding" />
    <meta name="twitter:site" content="@XavierGeerinck" />
    <meta name="twitter:creator" content="@XavierGeerinck" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Xavier Geerinck - Blog",
        "logo": "/false"
    },
    "url": "/predicting-instagram-with-dotnet-ml",
    "image": {
        "@type": "ImageObject",
        "url": "/assets/images/covers/gif/brain.gif",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/predicting-instagram-with-dotnet-ml"
    },
    "description": "For a new fun Project, I wanted to create an Artificial Intelligence model that will allow me to predict the comments and likes of new pictures that a user can post on Instagram based on their own historical data. Luckily thanks to ML.NET which was released during build 2018, we"
}
    </script>

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Predicting Instagram Pictures Likes and Comments with .NET Core and ML.NET" href="/feed.xml" />



    <!-- Enable MathJAX for LaTeX equations -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
        });
        </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>

</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-about" role="menuitem"><a href="/projects">Projects</a></li>
    <li class="nav-about" role="menuitem"><a href="/demos">Demos</a></li>
    <li class="nav-about" role="menuitem"><a href="/categories">Categories</a></li>
</ul>

    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/XavierGeerinck" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
            
                <a class="social-link social-link-tw" href="https://linkedin.com/in/xaviergeerinck" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg></a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post tag-coding ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="24 August 2018">24 August 2018</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/coding/'>CODING</a>,
                            
                        
                            
                               <a href='/tag/coding-dotnet/'>CODING-DOTNET</a>
                            
                        
                    
                </section>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/covers/gif/brain.gif)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                        <h1 class="post-full-title">Predicting Instagram Pictures Likes and Comments with .NET Core and ML.NET</h1>
                    <p>For a new fun Project, I wanted to create an Artificial Intelligence model that will allow me to predict the comments and likes of new pictures that a user can post on Instagram based on their own historical data.</p>

<p>Luckily thanks to <strong><a href="https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet">ML.NET</a></strong> which was released during build 2018, we are able to do this easily through a simple to create <em>pipeline</em>.</p>

<p>What will we be creating? Something like this architecture:</p>

<p><img src="/assets/images/posts/predicting-instagram-with-dotnet-ml/architecture.png" alt="/assets/images/posts/predicting-instagram-with-dotnet-ml/architecture.png" /></p>

<p>As in every Machine Learning projects, we have to do a few simple steps to go from data towards our eventual prediction:</p>

<ol>
  <li>Download / Prepare our data -&gt; <code class="highlighter-rouge">Step1.DataPrep</code> folder</li>
  <li>Train our Algorithm based on the data from step 1 -&gt; <code class="highlighter-rouge">Step2.DataTraining</code> folder</li>
  <li>Consume our model from step 2 -&gt; <code class="highlighter-rouge">Step3.DataPrediction</code> folder</li>
</ol>

<p>Resulting in the following folder structure:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root/
    Step1.DataPrep/ <span class="c"># NodeJS project so `npm init` to create a package.json</span>
        index.js
        config/index.js
        API/CognitiveServiceVision.js
        data/<span class="o">{</span><span class="k">*</span>.jpg,<span class="k">*</span>.json<span class="o">}</span> <span class="c"># Contains our pictures and metadata</span>
        output/result.csv <span class="c"># Contains our CSV created from our pictures</span>
    Step2.DataTraining/ <span class="c"># .NET Core solution -&gt; dotnet new console -o Step2.DataTraining</span>
    Step3.DataPrediction/ <span class="c"># .NET Core solution -&gt; dotnet new console -o Step3.DataPrediction</span>
</code></pre></div></div>

<h2 id="step-1---downloading--preparing-our-data">Step 1 - Downloading &amp; Preparing our data</h2>

<p>For Instagram data we could write our own scraper, or go the easy way and download one from the internet. In my case, I looked on Github and found a nice project called <a href="https://github.com/althonos/InstaLooter">InstaLooter</a> which is written in python and allows us to download instagram pictures + metadata from any user without being authenticated.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install InstaLooter</span>
pip <span class="nb">install</span> <span class="nt">--user</span> instalooter <span class="nt">--pre</span>

<span class="c"># Run InstaLooter in our Step1.DataPrep/data folder and download pictures from the &lt;instagram&gt; account</span>
instalooter user instagram <span class="nt">-d</span>
</code></pre></div></div>

<p>After all these pictures are downloaded, you will be able to start preparing them towards a <code class="highlighter-rouge">output/result.csv</code> file through a simple node.js script (see below). This script will just go through each image listed in the <code class="highlighter-rouge">data/</code> directory and send them to the <a href="https://azure.microsoft.com/en-us/services/cognitive-services/computer-vision/">Azure Cognitive Service - Computer Vision API</a> to retrieve the tags (which we Rate limit through our <a href="/throttling-api-calls">Throttling script</a>).</p>

<blockquote>
  <p><strong>Note:</strong> The Instagram API is limited to 1.000 calls, so you will be able to download 1.000 pictures whereafter InstaLooter will time-out.</p>
</blockquote>

<p><strong>index.js</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">delay</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">delay</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./config</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">API</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./API/CognitiveServiceVision</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">dataFolder</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">./data/</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">outputFolder</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">./output/</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">API</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">thirdParty</span><span class="p">.</span><span class="nx">cognitiveServices</span><span class="p">.</span><span class="nx">imageAnalyze</span><span class="p">.</span><span class="nx">apiKey</span><span class="p">);</span>

<span class="c1">// Get list of images in path with ascending time</span>
<span class="kd">let</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">dataFolder</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">i</span> <span class="o">=&gt;</span> <span class="nx">i</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="dl">'</span><span class="s1">.jpg</span><span class="dl">'</span><span class="p">)).</span><span class="nx">sort</span><span class="p">();</span>

<span class="c1">// Go through files, getting the metadata</span>
<span class="kd">let</span> <span class="nx">csvResult</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">shortcode;url;likes;comments;tags;</span><span class="se">\n</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// init buffer</span>
<span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">skipped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Process each image, getting the tags through Vision Cognitive Service, and checking the json</span>
<span class="c1">// Note: Out of order will appear here!</span>
<span class="kd">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Go through promises, but throttled</span>
    <span class="kd">const</span> <span class="nx">limit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// 10 at a time</span>

    <span class="c1">// files = files.slice(0, 50);</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[Progress] Processing </span><span class="p">${</span><span class="nx">limit</span><span class="p">}</span><span class="s2"> of the </span><span class="p">${</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2"> images`</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">currentFiles</span> <span class="o">=</span> <span class="nx">files</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">limit</span><span class="p">);</span>
        <span class="nx">files</span> <span class="o">=</span> <span class="nx">files</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">limit</span><span class="p">,</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

         <span class="c1">// Prepare promises</span>
         <span class="kd">let</span> <span class="nx">promises</span> <span class="o">=</span> <span class="p">[];</span>
         <span class="nx">currentFiles</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">i</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="c1">// Get tags</span>
                    <span class="kd">const</span> <span class="nx">imageBinary</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">readImageByPath</span><span class="p">(</span><span class="nx">dataFolder</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
                    <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">analyzeImage</span><span class="p">(</span><span class="nx">imageBinary</span><span class="p">);</span>
                    <span class="kd">const</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">t</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">name</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">"</span><span class="s2">,</span><span class="dl">"</span><span class="p">);</span>
            
                    <span class="c1">// Get JSON content</span>
                    <span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">dataFolder</span><span class="p">}${</span><span class="nx">i</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">.jpg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.json</span><span class="dl">'</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
                    <span class="nx">csvResult</span> <span class="o">+=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">shortcode</span><span class="p">}</span><span class="s2">;</span><span class="p">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">display_url</span><span class="p">}</span><span class="s2">;</span><span class="p">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">edge_media_preview_like</span><span class="p">.</span><span class="nx">count</span><span class="p">}</span><span class="s2">;</span><span class="p">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">edge_media_to_comment</span><span class="p">.</span><span class="nx">count</span><span class="p">}</span><span class="s2">;</span><span class="p">${</span><span class="nx">tags</span><span class="p">}</span><span class="s2">;\n`</span><span class="p">;</span>
        
                    <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">skipped</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
        
                <span class="c1">// Update progress</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[Progress] </span><span class="p">${</span><span class="nx">count</span> <span class="o">+</span> <span class="nx">skipped</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

                <span class="k">return</span> <span class="nx">resolve</span><span class="p">();</span>
            <span class="p">}));</span>
        <span class="p">})</span>
    
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">awaiting promises</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Sleeping for 1000ms`</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Write result</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">outputFolder</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">result.csv</span><span class="dl">'</span><span class="p">,</span> <span class="nx">csvResult</span><span class="p">);</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Processed </span><span class="p">${</span><span class="nx">count</span> <span class="o">+</span> <span class="nx">skipped</span><span class="p">}</span><span class="s2"> files, success: </span><span class="p">${</span><span class="nx">count</span><span class="p">}</span><span class="s2"> skipped: </span><span class="p">${</span><span class="nx">skipped</span><span class="p">}</span><span class="s2"> and saved to </span><span class="p">${</span><span class="nx">outputFolder</span><span class="p">}</span><span class="s2">result.csv`</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">start</span><span class="p">();</span>
</code></pre></div></div>

<p><strong>API/CognitiveServiceVision.js</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-fetch</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">util</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">readFile</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">);</span>

<span class="c1">// Based on https://github.com/Microsoft/BotFramework-Samples/blob/master/StackOverflow-Bot/StackBot/lib/bingsearchclient.js</span>
<span class="kd">class</span> <span class="nx">CognitiveServiceAnalyzeImage</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">apiKey</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">apiKey</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">apiKey is required</span><span class="dl">'</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">apiKey</span> <span class="o">=</span> <span class="nx">apiKey</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://westeurope.api.cognitive.microsoft.com/vision/v2.0/</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**
   * An util to help you get the binary data of an image
   * @param {string} imagePath 
   */</span>
  <span class="k">async</span> <span class="nx">readImageByPath</span><span class="p">(</span><span class="nx">imagePath</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">imageBinary</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">readFile</span><span class="p">(</span><span class="nx">imagePath</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">fileData</span> <span class="o">=</span> <span class="nx">imageBinary</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">fileData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">fileData</span><span class="p">[</span><span class="nx">i</span><span class="p">]}${</span><span class="nx">fileData</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]}</span><span class="s2">`</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">analyzeImageByUrl</span><span class="p">(</span><span class="nx">imageURL</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">analyze/</span><span class="dl">"</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">?</span><span class="dl">"</span>
      <span class="o">+</span> <span class="dl">"</span><span class="s2">returnFaceId=true</span><span class="dl">"</span>
      <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;visualFeatures=Tags,Description,Faces,Color</span><span class="dl">"</span>
      <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;returnFaceLandmarks=false</span><span class="dl">"</span>
      <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;returnFaceAttributes=age,gender,headPose,smile,facialHair,glasses,emotion,hair,makeup,occlusion,accessories,blur,exposure,noise</span><span class="dl">"</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">Ocp-Apim-Subscription-Key</span><span class="dl">"</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">apiKey</span>
        <span class="p">},</span>
        <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">url</span><span class="p">:</span> <span class="nx">imageURL</span> <span class="p">})</span>
      <span class="p">});</span>

      <span class="kd">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">analyzeImage</span><span class="p">(</span><span class="nx">imageBinary</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">analyze/</span><span class="dl">"</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">?</span><span class="dl">"</span>
      <span class="o">+</span> <span class="dl">"</span><span class="s2">returnFaceId=true</span><span class="dl">"</span>
      <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;visualFeatures=Tags,Description,Faces,Color</span><span class="dl">"</span>
      <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;returnFaceLandmarks=false</span><span class="dl">"</span>
      <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;returnFaceAttributes=age,gender,headPose,smile,facialHair,glasses,emotion,hair,makeup,occlusion,accessories,blur,exposure,noise</span><span class="dl">"</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/octet-stream</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">Ocp-Apim-Subscription-Key</span><span class="dl">"</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">apiKey</span>
        <span class="p">},</span>
        <span class="na">body</span><span class="p">:</span> <span class="nx">imageBinary</span>
      <span class="p">});</span>

      <span class="kd">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">CognitiveServiceAnalyzeImage</span><span class="p">;</span>
</code></pre></div></div>

<p>When we now look into the <code class="highlighter-rouge">output/result.csv</code> file after running <code class="highlighter-rouge">node index.js</code>, we will see something like the below, showing that we have our data as we want it for the next step.</p>

<pre><code class="language-csv">shortcode;url;likes;comments;tags;
BWAaIRoA-P7;https://instagram.fbru2-1.fna.fbcdn.net/vp/c5778b6ba5ec4397f23885d0ddc399ec/5C01F7C2/t51.2885-15/e35/19534728_388790801522556_2083772609937276928_n.jpg;1087963;4176;sky,outdoor,water,beach,nature,shore,sunset,clouds,promontory,rock,day,sandy;
BV-mVxyBlvv;https://instagram.fbru2-1.fna.fbcdn.net/vp/1a9647a992a0245b6c3ae652804a5013/5BFB7E57/t51.2885-15/e35/19623518_280508059085489_4094393732026073088_n.jpg;875193;3090;water,outdoor,green,sport,sunset,setting;
...
</code></pre>

<h2 id="step-2---training-our-ai-model">Step 2 - Training our AI Model</h2>

<p>Because we are using ML.NET, our model is straightforward. We will consume our CSV File and parse it by using a <code class="highlighter-rouge">TextLoader</code> which will detect our schema from the <code class="highlighter-rouge">.csv</code> header.</p>

<p>After that we split our <code class="highlighter-rouge">Tags</code> column on the character <code class="highlighter-rouge">,</code> and create a <code class="highlighter-rouge">OneHotVector</code> with it. This will take all the unique occurrences of our different tags (example: indoor,person,sun,sea,…) and will set a 1 if it occurs in that row. Giving us the following table for the tags given:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>sky</th>
      <th>outdoor</th>
      <th>water</th>
      <th>beach</th>
      <th>nature</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Row #1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <td>Row #2</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <td>Row #3</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>Row #4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>

<p>Now we train with this <code class="highlighter-rouge">OneHotVector</code> as our <code class="highlighter-rouge">Feature</code>, and tags as a <code class="highlighter-rouge">Label</code>, through a <code class="highlighter-rouge">StochasticDualCoordinateAscentRegressor</code> as our trainer, saving the model at the end as a simple <code class="highlighter-rouge">.zip</code> file.</p>

<p>To run this, just use <code class="highlighter-rouge">dotnet run</code> and wait for it to be done, you will see something as in:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS E:<span class="se">\&lt;</span>MyPath&gt;<span class="se">\S</span>tep2.DataTraining&gt; dotnet run
<span class="o">===================</span> Training Model Likes <span class="o">===================</span>
Automatically adding a MinMax normalization transform, use <span class="s1">'norm=Warn'</span> or <span class="s1">'norm=No'</span> to turn this behavior off.
Using 2 threads to train.
Automatically choosing a check frequency of 2.
Auto-tuning parameters: maxIterations <span class="o">=</span> 2114.
Auto-tuning parameters: L2 <span class="o">=</span> 0.001.
Auto-tuning parameters: L1Threshold <span class="o">(</span>L1/L2<span class="o">)</span> <span class="o">=</span> 0.25.
Using best model from iteration 74.
Not training a calibrator because it is not needed.
<span class="o">===================</span> Training Model Comments <span class="o">===================</span>
Automatically adding a MinMax normalization transform, use <span class="s1">'norm=Warn'</span> or <span class="s1">'norm=No'</span> to turn this behavior off.
Using 2 threads to train.
Automatically choosing a check frequency of 2.
Auto-tuning parameters: maxIterations <span class="o">=</span> 2114.
Auto-tuning parameters: L2 <span class="o">=</span> 0.001.
Auto-tuning parameters: L1Threshold <span class="o">(</span>L1/L2<span class="o">)</span> <span class="o">=</span> 0.25.
Using best model from iteration 48.
Not training a calibrator because it is not needed.
</code></pre></div></div>

<h3 id="step-2---code">Step 2 - Code</h3>

<p><strong>Program.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML.Models</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML.Trainers</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML.Transforms</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML.Runtime.Api</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Step2.DataTraining.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Step2.DataTraining</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="kt">string</span> <span class="n">dataPath</span> <span class="p">=</span> <span class="s">"../Step1.DataPrep/output/result.csv"</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Features: is our input (tags is our input -&gt; based on what do we predict?) </span>
            <span class="c1">// Labels: is our output (comments is our output -&gt; what do we want to predict?)</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"=================== Training Model Likes ==================="</span><span class="p">);</span>
            <span class="nf">CreateModelLikes</span><span class="p">().</span><span class="nf">Wait</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"=================== Training Model Comments ==================="</span><span class="p">);</span>
            <span class="nf">CreateModelComments</span><span class="p">().</span><span class="nf">Wait</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">CreateModelLikes</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// 1. Load in our data which has the header on the top and we use a csv so ';'</span>
            <span class="kt">var</span> <span class="n">pipeline</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LearningPipeline</span><span class="p">();</span>
            <span class="n">pipeline</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">TextLoader</span><span class="p">(</span><span class="n">dataPath</span><span class="p">).</span><span class="n">CreateFrom</span><span class="p">&lt;</span><span class="n">InstagramData</span><span class="p">&gt;(</span><span class="n">useHeader</span><span class="p">:</span> <span class="k">true</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span> <span class="sc">';'</span><span class="p">));</span>

            <span class="c1">// 2. Prepare our Label (what do we want to predict?)</span>
            <span class="c1">//      ColumnCopier: Duplicates columns from the dataset </span>
            <span class="c1">//          -&gt; we need to do this since Label is the column used and ours is called LabelLikes</span>
            <span class="n">pipeline</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">ColumnCopier</span><span class="p">((</span><span class="s">"LabelLikes"</span><span class="p">,</span> <span class="s">"Label"</span><span class="p">)));</span>

            <span class="c1">// 3. Prepare our features (based on what do we predict?)</span>
            <span class="c1">// Process Tags in a OneHotVector</span>
            <span class="c1">//      WordTokenizer: splits the text into words using the separator characters</span>
            <span class="c1">//      CategoricalOneHotVectorizer: We create a table of the different tags and set a 1 where the tag appears in our dataset</span>
            <span class="n">pipeline</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">WordTokenizer</span><span class="p">(</span><span class="s">"Tags"</span><span class="p">)</span> <span class="p">{</span> <span class="n">TermSeparators</span> <span class="p">=</span> <span class="s">","</span> <span class="p">});</span>
            <span class="n">pipeline</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">CategoricalOneHotVectorizer</span><span class="p">(</span><span class="s">"Tags"</span><span class="p">){</span> <span class="n">OutputKind</span> <span class="p">=</span> <span class="n">CategoricalTransformOutputKind</span><span class="p">.</span><span class="n">Bag</span> <span class="p">}</span> <span class="p">);</span>

            <span class="c1">// Prepare Features to train with, in this case with the "Tags" of our instagram pictures</span>
            <span class="c1">//      ColumnConcatenator: Concatenates one or more columns of the same item type</span>
            <span class="kt">var</span> <span class="n">features</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"Tags"</span> <span class="p">};</span>
            <span class="n">pipeline</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">ColumnConcatenator</span><span class="p">(</span><span class="s">"Features"</span><span class="p">,</span> <span class="s">"Tags"</span><span class="p">));</span>

            <span class="c1">// 4. Train our model</span>
            <span class="n">pipeline</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">StochasticDualCoordinateAscentRegressor</span><span class="p">());</span>
            <span class="n">PredictionModel</span><span class="p">&lt;</span><span class="n">InstagramData</span><span class="p">,</span> <span class="n">PredictedLikes</span><span class="p">&gt;</span> <span class="n">model</span> <span class="p">=</span> <span class="n">pipeline</span><span class="p">.</span><span class="n">Train</span><span class="p">&lt;</span><span class="n">InstagramData</span><span class="p">,</span> <span class="n">PredictedLikes</span><span class="p">&gt;();</span>

            <span class="c1">// 5. Save the trained model</span>
            <span class="k">await</span> <span class="n">model</span><span class="p">.</span><span class="nf">WriteAsync</span><span class="p">(</span><span class="s">"model_likes.zip"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// ==================================================================</span>
        <span class="c1">// Do the same for CreateModelComments..., changing Likes to Comments</span>
        <span class="c1">// Omitted for readability</span>
        <span class="c1">// ==================================================================</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Models/InstagramData.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Imports...</span>

<span class="k">namespace</span> <span class="nn">Step2.DataTraining.Models</span>
<span class="p">{</span>
    <span class="c1">// input for prediction operations</span>
    <span class="c1">// - First 4 properties are inputs/features used to predict the label</span>
    <span class="c1">// - Label is what you are predicting, and is only set when training</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">InstagramData</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">Column</span><span class="p">(</span><span class="n">ordinal</span><span class="p">:</span> <span class="s">"0"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">Shortcode</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="p">[</span><span class="nf">Column</span><span class="p">(</span><span class="n">ordinal</span><span class="p">:</span> <span class="s">"1"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">URL</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// We set name: "Label" since we will predict this</span>
        <span class="p">[</span><span class="nf">Column</span><span class="p">(</span><span class="n">ordinal</span><span class="p">:</span> <span class="s">"2"</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s">"LabelLikes"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">LabelLikes</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="p">[</span><span class="nf">Column</span><span class="p">(</span><span class="n">ordinal</span><span class="p">:</span> <span class="s">"3"</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s">"LabelComments"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">LabelComments</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="p">[</span><span class="nf">Column</span><span class="p">(</span><span class="n">ordinal</span><span class="p">:</span> <span class="s">"4"</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s">"Tags"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Tags</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Models/PredictedComments.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Imports...</span>

<span class="k">namespace</span> <span class="nn">Step2.DataTraining.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PredictedComments</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">ColumnName</span><span class="p">(</span><span class="s">"Score"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">Score</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Models/PredictedLikes.cs</strong></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Imports...</span>

<span class="k">namespace</span> <span class="nn">Step2.DataTraining.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PredictedLikes</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">ColumnName</span><span class="p">(</span><span class="s">"Score"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">Score</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="step-3---consuming-our-ai-model">Step 3 - Consuming our AI Model</h2>

<p>Our model is now trained and created, now we just have to consume it. For this we just load in the zip files through <code class="highlighter-rouge">ML.NET</code> and call the <code class="highlighter-rouge">.Predict</code> function on the model. To predict likes and comments based on Tags, we load in tags through the CLI and the <code class="highlighter-rouge">args</code> parameter in our Main method, resulting in:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS E:<span class="se">\&lt;</span>MyPath&gt;<span class="se">\S</span>tep3.DataPrediction&gt; dotnet run indoor,sun
Predicted likes: 670824.3
Predicted comments: 5451.721
</code></pre></div></div>

<p>Which is close to the data that we used to train with (looking on sight and comparing values).</p>

<blockquote>
  <p><strong>Note:</strong> We are training with just 700 lines of data, production models have millions of lines of these data and will result in better predictions. Data is always key in AI algorithms.</p>
</blockquote>

<h3 id="step-3---code">Step 3 - Code</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ML.Runtime.Api</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Step3.DataPrediction.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Step3.DataPrediction</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">modelPathComments</span> <span class="p">=</span> <span class="s">"../Step2.DataTraining/model_comments.zip"</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">modelPathLikes</span> <span class="p">=</span> <span class="s">"../Step2.DataTraining/model_likes.zip"</span><span class="p">;</span>

        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">tags</span> <span class="p">=</span> <span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
            <span class="nf">PredictLikes</span><span class="p">(</span><span class="n">tags</span><span class="p">).</span><span class="nf">Wait</span><span class="p">();</span>
            <span class="nf">PredictComments</span><span class="p">(</span><span class="n">tags</span><span class="p">).</span><span class="nf">Wait</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="k">static</span> <span class="n">Task</span> <span class="nf">PredictLikes</span><span class="p">(</span><span class="kt">string</span> <span class="n">tags</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="k">await</span> <span class="n">PredictionModel</span><span class="p">.</span><span class="n">ReadAsync</span><span class="p">&lt;</span><span class="n">InstagramData</span><span class="p">,</span> <span class="n">PredictedLikes</span><span class="p">&gt;(</span><span class="n">modelPathLikes</span><span class="p">);</span>

            <span class="c1">// Predict</span>
            <span class="kt">var</span> <span class="n">prediction</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">Predict</span><span class="p">(</span><span class="k">new</span> <span class="n">InstagramData</span>
            <span class="p">{</span>
                <span class="n">Tags</span> <span class="p">=</span> <span class="n">tags</span><span class="p">,</span>
            <span class="p">});</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Predicted likes: </span><span class="p">{</span><span class="n">prediction</span><span class="p">.</span><span class="n">Score</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="k">static</span> <span class="n">Task</span> <span class="nf">PredictComments</span><span class="p">(</span><span class="kt">string</span> <span class="n">tags</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="k">await</span> <span class="n">PredictionModel</span><span class="p">.</span><span class="n">ReadAsync</span><span class="p">&lt;</span><span class="n">InstagramData</span><span class="p">,</span> <span class="n">PredictedComments</span><span class="p">&gt;(</span><span class="n">modelPathComments</span><span class="p">);</span>

            <span class="c1">// Predict</span>
            <span class="kt">var</span> <span class="n">prediction</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">Predict</span><span class="p">(</span><span class="k">new</span> <span class="n">InstagramData</span>
            <span class="p">{</span>
                <span class="n">Tags</span> <span class="p">=</span> <span class="n">tags</span><span class="p">,</span>
            <span class="p">});</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Predicted comments: </span><span class="p">{</span><span class="n">prediction</span><span class="p">.</span><span class="n">Score</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I hope you enjoyed this article, let me know in the comments below on the results you achieved. For the final source code, feel free to check the repository at: <a href="https://github.com/thebillkidy/blog-instagram-correlator">https://github.com/thebillkidy/blog-instagram-correlator</a></p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/avatar.jpg" alt="xavier" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/xavier">Xavier Geerinck</a></h4>
                                
                                    <p>Xavier works as a Cloud Solution Architect at Microsoft, helping its customer unlock the full potential of the cloud. Even though he is still considered a young graduate, he achieved his first success at the age 16, by creating and selling his first startup. He then took this knowledge to create and help more startups in different markets such as technology, social media, philanthropy and home care. While in the meantime gaining more enterprise insights at renowned enterprises such as Nokia, Cisco and now Microsoft.</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/xavier">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = window.location.href;
                            this.page.identifier = '/predicting-instagram-with-dotnet-ml';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://xaviergeerinck.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/covers/blog-cover.png)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Xavier Geerinck - Blog &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/coding/">Coding</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/azure-automated-container-push">Create a script to deploy a container automatically with Azure Container Registry</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/stream-sampling">Sampling a real-time stream</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/minecraft-rfc-scanner">Building a Minecraft Puppet Scanner with Event Hub, a NFC 522 Reader and a Raspberry PI</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/coding/">
                                
                                    See all 30 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/throttling-api-calls">
                <div class="post-card-image" style="background-image: url(/assets/images/covers/coding.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/throttling-api-calls">
                <header class="post-card-header">
                    
                        
                            
                               <span class="post-card-tags">Coding</span>
                            
                        
                            
                                <span class="post-card-tags">Coding-javascript</span>
                            
                        
                    

                    <h2 class="post-card-title">Creating a throttled REST API Consumer</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>A common thing in Node.js is to create a REST API consumer that will perform a REST call. Due to the rise of many REST APIs, you might find yourself in the situation</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/avatar.jpg" alt="Xavier Geerinck" />
                        
                        <span class="post-card-author">
                            <a href="/author/xavier/">Xavier Geerinck</a>
                        </span>
                    
                
            </footer>
        </div>
    </article>

            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/lessons-learned-after-1-year-at-microsoft">
                <div class="post-card-image" style="background-image: url(/assets/images/covers/microsoft.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/lessons-learned-after-1-year-at-microsoft">
                <header class="post-card-header">
                    
                        
                            
                               <span class="post-card-tags">Experience</span>
                            
                        
                            
                                <span class="post-card-tags">Business</span>
                            
                        
                    

                    <h2 class="post-card-title">Lessons learned after being at Microsoft for 1 year</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>Today marks my 1st anniversary of working as a Cloud Solution Architect at Microsoft, and wow what an exciting time it has been! But before I go deeper into my experiences and lessons</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/avatar.jpg" alt="Xavier Geerinck" />
                        
                        <span class="post-card-author">
                            <a href="/author/xavier/">Xavier Geerinck</a>
                        </span>
                    
                
            </footer>
        </div>
    </article>

            
        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="/">
            
                <img src="/assets/images/favicon.png" alt="Xavier Geerinck - Blog icon" />
            
            <span>Xavier Geerinck - Blog</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Predicting Instagram Pictures Likes and Comments with .NET Core and ML.NET</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Predicting+Instagram+Pictures+Likes+and+Comments+with+.NET+Core+and+ML.NET&amp;url=https://thebillkidy.github.io/predicting-instagram-with-dotnet-ml"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://thebillkidy.github.io/predicting-instagram-with-dotnet-ml"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
        <a class="floating-header-share-li" href="https://www.linkedin.com/shareArticle?mini=true&url=https://thebillkidy.github.io/predicting-instagram-with-dotnet-ml&title=Predicting+Instagram+Pictures+Likes+and+Comments+with+.NET+Core+and+ML.NET&source=https://thebillkidy.github.io/"
            onclick="window.open(this.href, 'share-linkedin','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="/">Xavier Geerinck - Blog</a> &copy; 2020</section>
                <section class="poweredby">Made with ❤ in Belgium</section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/XavierGeerinck" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://linkedin.com/in/xaviergeerinck" target="_blank" rel="noopener">LinkedIn</a>
                </nav>
            </div>
        </footer>
    </div>

    <!-- The big email subscribe modal content -->
     

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
    <!-- <script>hljs.initHighlightingOnLoad();</script> -->

    <script>
        var blocks = document.querySelectorAll('div[class^=language-]');
        blocks.forEach((b) => {
            var language = b.className.split(" ")[0].match(/language\-(.*)/)[1];

            var codeBlocks = b.querySelectorAll('pre code');

            // Highlight the code
            codeBlocks.forEach((i) => {
                var text = i.innerText;
                var highlightedText = hljs.highlight(language, text);
                i.innerHTML = highlightedText.value;
            });

            // Add line numbers

            codeBlocks.forEach((i) => {            
                i.innerHTML = i.innerHTML.split("\n").map(function (i, idx, arr) {
                    // The last line seems to be empty, so don't work with it
                    if (idx == arr.length - 1) {
                        return '';
                    }

                    return '<span class="line-numbers"">' + i + '</span>' + "\n";
                }).join("");
            });
        });
    </script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fitvids/1.2.0/jquery.fitvids.min.js"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27398198-1', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

</body>
</html>
